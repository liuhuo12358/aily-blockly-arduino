name: CI & CD Pipeline

on:
  push:
    branches:
      - deploy
    tags:
      - 'v*' # 增加标签触发，这通常是申请签名时的加分项

jobs:
  # 任务 1：Windows 客户端构建 (新增，用于向 SignPath 证明构建能力)
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install Dependencies
        run: |
          npm install -g @angular/cli
          npm ci

      - name: Compile Windows Executable
        run: |
          npm run build -- --win
        env:
          NODE_ENV: production

      # --- SignPath 预留位 (申请时给审核员看的重点) ---
      # - name: Sign with SignPath
      #   uses: signpath/github-action@v1
      #   with:
      #     api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
      #     ... (待申请通过后完善)
      
      - name: Archive Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: AilyBlockly-Windows-Package
          path: dist/aily-blockly/*.exe # 根据你 electron-builder 的实际输出路径调整

  # 任务 2：macOS 客户端构建
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 22.x
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install Dependencies
        run: |
          npm install -g @angular/cli
          npm ci

      - name: Compile macOS Executable
        run: |
          npm run build -- --mac
        env:
          NODE_ENV: production

      # --- Apple 代码签名和公证 ---
      - name: Import Codesign Certificates
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.APPLE_SIGNING_CERT }}
          p12-password: ${{ secrets.APPLE_SIGNING_PASSWORD }}

      - name: Find DMG file
        id: find_dmg
        run: |
          DMG_PATH=$(find dist/aily-blockly -name "*.dmg" -type f | head -n 1)
          echo "dmg_path=$DMG_PATH" >> $GITHUB_OUTPUT
          echo "Found DMG at: $DMG_PATH"

      - name: Debug - Check DMG file
        run: |
          echo "DMG file: ${{ steps.find_dmg.outputs.dmg_path }}"
          ls -lh "${{ steps.find_dmg.outputs.dmg_path }}"
          file "${{ steps.find_dmg.outputs.dmg_path }}"

      - name: Notarize and Staple macOS App
        id: notarize
        continue-on-error: true
        uses: lando/notarize-action@v2
        with:
          product-path: "${{ steps.find_dmg.outputs.dmg_path }}"
          appstore-connect-username: ${{ secrets.APPLE_ID }}
          appstore-connect-password: ${{ secrets.APPLE_APP_PASSWORD }}
          appstore-connect-team-id: ${{ secrets.APPLE_TEAM_ID }}
          primary-bundle-id: "blockly.aily.pro"

      - name: Debug - Notarization Result
        run: |
          echo "Notarization step outcome: ${{ steps.notarize.outcome }}"
          if [ "${{ steps.notarize.outcome }}" = "failure" ]; then
            echo "⚠️  Notarization failed, but continuing with artifact upload..."
          else
            echo "✓ Notarization completed successfully"
          fi

      - name: Verify Notarization
        continue-on-error: true
        run: |
          echo "Checking file signature..."
          codesign -dvv "${{ steps.find_dmg.outputs.dmg_path }}" || echo "File not code-signed"
          echo ""
          echo "Running spctl verification..."
          spctl -a -vvv -t install "${{ steps.find_dmg.outputs.dmg_path }}" || echo "spctl verification failed"
          echo ""
          echo "Running stapler validate..."
          stapler validate "${{ steps.find_dmg.outputs.dmg_path }}" || echo "Stapler validation failed"
      
      - name: Archive macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: AilyBlockly-macOS-Package
          path: dist/aily-blockly/*.dmg

  # 任务 3：发布到 GitHub Release
  release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: AilyBlockly-Windows-Package
          path: ./release

      - name: Download macOS Artifact
        uses: actions/download-artifact@v4
        with:
          name: AilyBlockly-macOS-Package
          path: ./release

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: ./release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}