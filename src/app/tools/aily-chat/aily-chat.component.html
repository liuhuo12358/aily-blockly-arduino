@if (currentUrl == "/aily-chat") {
<app-sub-window [title]="'AI ASSISTANT'" [winBtns]="['go-main', 'minimize', 'maximize', 'close']">
  <ng-container *ngTemplateOutlet="windowBoxTemplate"></ng-container>
</app-sub-window>
} @else {
<app-tool-container [title]="'AI ASSISTANT' | translate" (closeEvent)="close()">
  <ng-container header-btns>
    <!-- <div class="btn ccenter" (click)="demandEdit()" nz-tooltip nzTooltipPlacement="bottom" nzTooltipTitle="需求管理">
      <i class="fa-light fa-list-check"></i>
    </div> -->
    <div class="btn ccenter" [class.active]="showSettings" (click)="openSettings($event)" nz-tooltip nzTooltipPlacement="bottom"
      [nzTooltipTitle]="'AILY_CHAT.SETTINGS' | translate">
      <i class="fa-light fa-gear"></i>
    </div>
    <div class="btn ccenter" (click)="openHistoryChat($event)" nz-tooltip nzTooltipPlacement="bottom"
      [nzTooltipTitle]="'AILY_CHAT.HISTORY' | translate">
      <i class="fa-light fa-clock-rotate-left"></i>
    </div>
    <div class="btn ccenter" (click)="newChat()" nz-tooltip nzTooltipPlacement="bottom"
      [nzTooltipTitle]="'AILY_CHAT.NEW_CHAT' | translate">
      <i class="fa-light fa-message-plus"></i>
    </div>
  </ng-container>

  <!-- 整个聊天区域的容器 -->
  <div class="aily-chat-wrapper">
    <div class="todo-panel-container">
      <app-floating-todo [sessionId]="sessionId"></app-floating-todo>
    </div>
    <ng-container *ngTemplateOutlet="windowBoxTemplate"></ng-container>
  </div>
</app-tool-container>
}
<ng-template #windowBoxTemplate>
  <div class="window-box">
    <!-- 对话内容 -->
    <div class="dialog-list sscroll" #chatContainer (scroll)="checkUserScroll()">
      @if(list.length > 0){
      <!-- <ngx-simplebar #simplebarRef [options]="options"> -->
      <div class="dialogs">
        @for (item of list; track item) {
        <aily-dialog [role]="item.role" [content]="item.content" [doing]="item.state=='doing'"></aily-dialog>
        }
      </div>
      <!-- </ngx-simplebar> -->
      }@else{
      <div class="guide-box ccenter">
        <i class="fa-light fa-star-christmas"></i>
        <div class="title">{{ 'AILY_CHAT.SERVICE_TITLE' | translate }}</div>
        <div class="text">{{ 'AILY_CHAT.DISCLAIMER' | translate }}</div>
        <div></div>
      </div>
      }
    </div>
    <!-- 发送部分 -->
    <div class="sender" nz-resizable [style.height.px]="bottomHeight" [nzMaxHeight]="600" [nzMinHeight]="180"
      (nzResize)="onContentResize($event)">
      <nz-resize-handle nzDirection="top">
        <div class="line"></div>
      </nz-resize-handle>

      <div class="s-box">
        <!-- 快捷发送栏 -->
        <!-- <div class="settings" style="padding: 0;">
          <div class="btns">
            <div class="btn ccenter" nz-tooltip nzTooltipTitle="添加文件">
              <i class="fa-light fa-file-circle-plus"></i>
            </div>
          </div>
        </div> -->
        <div class="input-box">
          @if( selectContent.length > 0 ) {
          <div class="resource-list">
            @for( item of selectContent; track $index) {
            <div class="resource-item">
              @if(item.type == 'file') {
              <i class="fa-light fa-file"></i>
              }@else if(item.type == 'folder') {
              <i class="fa-light fa-folder"></i>
              }@else if(item.type == 'url') {
              <i class="fa-light fa-link"></i>
              }
              <span class="resource-name">{{ item.name }}</span>
              <div class="btn ccenter" (click)="removeResource($index)">
                <i class="fa-light fa-xmark"></i>
              </div>
            </div>
            }
          </div>
          }
          <textarea #chatTextarea class="sscroll" [(ngModel)]="inputValue"
            (keydown)="onKeyDown($event)">
          </textarea>
          <div class="btns">
            <div class="btn ccenter" nz-tooltip nzTooltipPlacement="bottom"
              [nzTooltipTitle]="'AILY_CHAT.ADD_CONTEXT' | translate" (click)="openAddList()">
              <i class="fa-light fa-paperclip"></i>
            </div>
            @if(showAddList){
            <div class="list-box">
              <div class="btn2 ccenter" (click)="openAddList()" style="margin-top: -1px;">
                <i class="fa-light fa-angle-left"></i>
              </div>
            </div>
            <div class="btn2 ccenter " nz-tooltip [nzTooltipTitle]="'AILY_CHAT.ADD_FILE' | translate"
              (click)="addFile()">
              <i class="fa-light fa-file-plus"></i>
            </div>
            <div class="btn2 ccenter " nz-tooltip [nzTooltipTitle]="'AILY_CHAT.ADD_FOLDER' | translate"
              (click)="addFolder()">
              <i class="fa-light fa-folder-plus"></i>
            </div>
            <!-- <div class="btn2 ccenter " nz-tooltip [nzTooltipTitle]="'AILY_CHAT.ADD_WEBSITE' | translate"
              (click)="addUrl()">
              <i class="fa-light fa-globe-pointer"></i>
            </div> -->
            }
            <!-- 模式选择 -->
            <div class="btn mode ccenter" (click)="switchMode($event)">
              @if(currentMode === 'agent') {
              <i class="fa-light fa-user-astronaut"></i><span>{{ 'AILY_CHAT.MODE_AGENT' | translate }}</span>
              } @else {
              <i class="fa-light fa-comment-smile"></i><span>{{ 'AILY_CHAT.MODE_QA' | translate }}</span>
              }
            </div>
            <div class="btn right ccenter" [ngClass]="{'lloading':isWaiting}" nzTooltipPlacement="bottom" nz-tooltip
              [nzTooltipTitle]="isWaiting ? ('AILY_CHAT.STOP' | translate) : ('AILY_CHAT.SEND' | translate)"
              (click)="sendButtonClick()">
              @if(isWaiting){
              <div class="stop-box ccenter">
                <i class="fa-light fa-stop"></i>
              </div>
              <div class="spinner-box ccenter">
                <i class="fa-light fa-spinner-third"></i>
              </div>
              }@else {
              <i class="fa-light fa-paper-plane"></i>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
    @if(showSettings){
    <aily-chat-settings (close)="showSettings = false" (saved)="onSettingsSaved()"></aily-chat-settings>
    }
  </div>
  @if(!isLoggedIn){
  <app-login></app-login>
  }
</ng-template>

@if (showHistoryList) {
<app-menu [menuList]="HistoryList" [position]="historyListPosition" [width]="300" (closeEvent)="closeMenu()"
  (itemClickEvent)="menuClick($event)"></app-menu>
}

@if(showMode){
<app-menu class="mode-menu" [menuList]="ModeList" [position]="modeListPosition" (closeEvent)="closeMenu()"
  (itemClickEvent)="modeMenuClick($event)"></app-menu>
}

<!-- 新手引导蒙板 -->
@if (showOnboarding) {
<div class="onboarding-overlay">
  <!-- 高亮区域 -->
  <div class="onboarding-highlight" [ngStyle]="highlightStyle"></div>
  <!-- 提示框 -->
  <div class="onboarding-tooltip" [ngStyle]="tooltipStyle">
    <div class="tooltip-content">
      <div class="tooltip-step">{{ currentStep + 1 }} / {{ onboardingSteps.length }}</div>
      <div class="tooltip-title">{{ onboardingSteps[currentStep].titleKey | translate }}</div>
      <div class="tooltip-desc">{{ onboardingSteps[currentStep].descKey | translate }}</div>
      <div class="tooltip-actions">
        <button class="btn-skip" (click)="skipOnboarding()">{{ 'AILY_CHAT.ONBOARDING.SKIP' | translate }}</button>
        <div class="btn-group">
          @if (currentStep > 0) {
          <button class="btn-prev" (click)="prevStep()">{{ 'AILY_CHAT.ONBOARDING.PREV' | translate }}</button>
          }
          <button class="btn-next" (click)="nextStep()">
            {{ currentStep < onboardingSteps.length - 1 ? ('AILY_CHAT.ONBOARDING.NEXT' | translate) :
              ('AILY_CHAT.ONBOARDING.DONE' | translate) }}
          </button>
        </div>
      </div>
    </div>
    <!-- 箭头指示器 -->
    <div class="tooltip-arrow" [class]="'arrow-' + onboardingSteps[currentStep].position" [ngStyle]="arrowStyle"></div>
  </div>
</div>
}