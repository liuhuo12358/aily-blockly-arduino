<div class="editor-box">
    <!-- <div class="test">以下为测试功能，普通用户暂不可用</div> -->
    <div class="content sscroll">
        <div class="item">
            <div class="item-title">
                <span>最大循环次数</span>
                <i class="fa-light fa-circle-question help-icon" (click)="openHelpUrl('maxCount')"></i>
            </div>
            <div>
                <input nz-input [(ngModel)]="maxCount" />
            </div>
        </div>
        <div class="item items-section">
            <div class="item-title">
                <span>安全工作区</span>
                <i class="fa-light fa-circle-question help-icon" (click)="openHelpUrl('workspace')"></i>
            </div>
            <div class="items-list">
                <div class="items-header">
                    <label nz-checkbox [(ngModel)]="allWorkspaceChecked" [nzIndeterminate]="workspaceIndeterminate"
                        (ngModelChange)="onAllWorkspaceCheckedChange($event)">
                        全选
                    </label>
                </div>
                <div class="items-container">
                    <div *ngFor="let option of workspaceOptions" class="item-wrapper">
                        <label nz-checkbox [(ngModel)]="option.enabled" (ngModelChange)="onWorkspaceCheckedChange()"
                            class="list-item">
                            {{ option.displayName }}
                        </label>
                    </div>
                </div>
            </div>
        </div>
        <div class="item items-section">
            <div class="item-title">
                <span>可用工具</span>
                <i class="fa-light fa-circle-question help-icon" (click)="openHelpUrl('tools')"></i>
            </div>
            <div class="items-list">
                <div class="items-header">
                    <label nz-checkbox [(ngModel)]="allChecked" [nzIndeterminate]="indeterminate"
                        (ngModelChange)="onAllCheckedChange($event)">
                        全选
                    </label>
                    <span class="items-count">{{ enabledToolsCount }} / {{ availableTools.length }} 已启用</span>
                </div>
                <div class="items-container sscroll">
                    <div *ngFor="let tool of availableTools" class="item-wrapper">
                        <label nz-checkbox [(ngModel)]="tool.enabled" (ngModelChange)="onToolCheckedChange()"
                            class="list-item">
                            {{ tool.displayName }}
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="item items-section">
            <div class="item-title">
                <span>模型管理</span>
                <i class="fa-light fa-circle-question help-icon" (click)="openHelpUrl('tools')"></i>
            </div>
            <div class="items-list">
                <div class="items-header">
                    <label nz-checkbox [(ngModel)]="allModelsChecked" [nzIndeterminate]="modelsIndeterminate"
                        (ngModelChange)="onAllModelsCheckedChange($event)">
                        全选
                    </label>
                    <span class="items-count">{{ enabledModelsCount }} / {{ modelList.length }} 已启用</span>
                    @if(useCustomApiKey){
                    <button nz-button nzType="link" nzSize="small" (click)="toggleAddModelForm()">
                        <i class="fa-light" [ngClass]="showAddModelForm ? 'fa-minus' : 'fa-plus'"></i>
                        {{ showAddModelForm ? '取消' : '添加模型' }}
                    </button>
                    }
                </div>
                
                <!-- 添加模型表单 -->
                @if(showAddModelForm){
                <div class="add-model-form">
                    <div class="form-row">
                        <input nz-input [(ngModel)]="newModel.model" placeholder="模型ID (如: gpt-4)" />
                    </div>
                    <div class="form-row">
                        <input nz-input [(ngModel)]="newModel.name" placeholder="显示名称 (如: GPT-4)" />
                    </div>
                    <div class="form-row">
                        <input nz-input [(ngModel)]="newModel.family" placeholder="模型家族 (如: openai)" />
                    </div>
                    <div class="form-row">
                        <input nz-input [(ngModel)]="newModel.speed" placeholder="速度标识 (如: 1x)" />
                    </div>
                    <div class="form-actions">
                        <button nz-button nzType="primary" nzSize="small" (click)="addCustomModel()">
                            确认添加
                        </button>
                    </div>
                </div>
                }
                
                <div class="items-container sscroll">
                    <div *ngFor="let model of modelList" class="item-wrapper model-item">
                        <label nz-checkbox [(ngModel)]="model.enabled" (ngModelChange)="onModelCheckedChange()"
                            class="list-item">
                            <span class="model-name">{{ model.name }}</span>
                            <span class="model-id">({{ model.model }})</span>
                            @if(model.isCustom){
                            <span class="custom-badge">自定义</span>
                            }
                        </label>
                        @if(model.isCustom){
                        <button nz-button nzType="link" nzSize="small" nzDanger (click)="removeModel(model)"
                            class="delete-btn">
                            <i class="fa-light fa-trash"></i>
                        </button>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="item">
            <div class="item-title">
                <span>使用自有API KEY</span>
                <i class="fa-light fa-circle-question help-icon" (click)="openHelpUrl('apiKey')"></i>
                <span style="margin: -1px 0 0 10px;">
                    <nz-switch [(ngModel)]="useCustomApiKey" [nzSize]="'small'"></nz-switch>
                </span>
            </div>
            @if(useCustomApiKey){
            <div>
                <input nz-input [(ngModel)]="baseUrl" placeholder="base url" />
                <input nz-input [(ngModel)]="apiKey" placeholder="api key" />
            </div>
            }
        </div>
    </div>

    <div class="bottom">
        <button class="sync-btn" nz-button (click)="onClose()">
            返回
        </button>
        <button class="sync-btn" nz-button nzType="primary" (click)="onSave()">
            保存
        </button>
    </div>
</div>