<div class="editor-box">
    <div class="test ccenter">以下为测试功能，普通用户暂不可用</div>
    <div class="content sscroll">

        <!-- 模型管理 -->
        <div class="item items-section">
            <div class="item-title">
                <span>模型管理</span>
                <i class="fa-light fa-circle-question help-icon" (click)="openHelpUrl('tools')"></i>
            </div>
            <div class="items-list">
                <div class="items-header">
                    <label nz-checkbox [(ngModel)]="allModelsChecked" [nzIndeterminate]="modelsIndeterminate"
                        (ngModelChange)="onAllModelsCheckedChange($event)">
                        全选
                    </label>
                    <span class="items-count">{{ enabledModelsCount }} / {{ modelList.length }} 已启用</span>
                </div>

                <div class="items-container">
                    @for (model of modelList; track model.model) {
                    <div class="item-wrapper model-item">
                        <div class="model-info">
                            @if(editingModel === model){
                            <!-- 编辑模式：显示表单 -->
                            <ng-container *ngTemplateOutlet="modelFormTemplate"></ng-container>
                            } @else {
                            <!-- 显示模式：显示模型信息 -->
                            <label nz-checkbox [(ngModel)]="model.enabled" (ngModelChange)="onModelCheckedChange()"
                                class="list-item">
                                <span class="model-name">{{ model.name }}</span>
                                <span class="model-id">{{ model.model }}</span>
                            </label>
                            @if(model.isCustom){
                            <div class="model-actions">
                                <button nz-button nzType="link" nzSize="small" (click)="editModel(model)"
                                    class="edit-btn">
                                    <i class="fa-light fa-pen"></i>
                                </button>
                                <button nz-button nzType="link" nzSize="small" nzDanger (click)="removeModel(model)"
                                    class="delete-btn">
                                    <i class="fa-light fa-trash"></i>
                                </button>
                            </div>
                            }
                            }
                        </div>
                    </div>
                    }
                    <!-- 添加新模型 item / 表单 -->
                    <div class="item-wrapper model-item model-item-add">
                        <div class="model-info">
                            @if(!showAddModelForm || editingModel){
                            <div class="add-model-btn" (click)="openAddModelForm()">
                                <i class="fa-light fa-plus"></i>
                                添加新模型
                            </div>
                            } @else {
                            <!-- 添加模式：显示表单 -->
                            <ng-container *ngTemplateOutlet="modelFormTemplate"></ng-container>
                            }
                        </div>
                    </div>
                </div>

                <!-- 模型表单模板 -->
                <ng-template #modelFormTemplate>
                    <div class="add-model-form">
                        <div class="form-row">
                            <input nz-input [(ngModel)]="newModel.name" placeholder="模型名称 (如: GPT-4)" />
                        </div>
                        <div class="form-row">
                            <input nz-input [(ngModel)]="newModel.model" placeholder="模型ID (如: gpt-4)" />
                        </div>
                        <div class="form-row">
                            <input nz-input [(ngModel)]="newModel.baseUrl"
                                placeholder="Base URL (如: https://api.openai.com/v1)" />
                        </div>
                        <div class="form-row">
                            <input nz-input [(ngModel)]="newModel.apiKey" placeholder="API Key" type="password" />
                        </div>
                        <div class="form-actions">
                            <button nz-button nzSize="small" (click)="toggleAddModelForm()">
                                取消
                            </button>
                            <button nz-button nzType="primary" nzSize="small" (click)="addCustomModel()">
                                保存
                            </button>
                        </div>
                    </div>
                </ng-template>
            </div>
        </div>

        <div class="item items-section">
            <div class="item-title">
                <span>安全工作区</span>
                <i class="fa-light fa-circle-question help-icon" (click)="openHelpUrl('workspace')"></i>
            </div>
            <div class="items-list">
                <div class="items-header">
                    <label nz-checkbox [(ngModel)]="allWorkspaceChecked" [nzIndeterminate]="workspaceIndeterminate"
                        (ngModelChange)="onAllWorkspaceCheckedChange($event)">
                        全选
                    </label>
                </div>
                <div class="items-container">
                    @for (option of workspaceOptions; track option.displayName) {
                    <div class="item-wrapper">
                        <label nz-checkbox [(ngModel)]="option.enabled" (ngModelChange)="onWorkspaceCheckedChange()"
                            class="list-item">
                            {{ option.displayName }}
                        </label>
                    </div>
                    }
                </div>
            </div>
        </div>

        <div class="item items-section">
            <div class="item-title">
                <span>可用工具</span>
                <i class="fa-light fa-circle-question help-icon" (click)="openHelpUrl('tools')"></i>
            </div>
            <div class="items-list">
                <div class="items-header">
                    <label nz-checkbox [(ngModel)]="allChecked" [nzIndeterminate]="indeterminate"
                        (ngModelChange)="onAllCheckedChange($event)">
                        全选
                    </label>
                    <span class="items-count">{{ enabledToolsCount }} / {{ availableTools.length }} 已启用</span>
                </div>
                <div class="items-container sscroll">
                    @for (tool of availableTools; track tool.displayName) {
                    <div class="item-wrapper">
                        <label nz-checkbox [(ngModel)]="tool.enabled" (ngModelChange)="onToolCheckedChange()"
                            class="list-item">
                            {{ tool.displayName }}
                        </label>
                    </div>
                    }
                </div>
            </div>
        </div>

        <div class="item items-section">
            <div class="item-title">
                <span>其他设置</span>
            </div>
            <div class="items-list">
                <div>最大循环次数 <i class="fa-light fa-circle-question help-icon" (click)="openHelpUrl('maxCount')"></i>
                </div>
                <input nz-input [(ngModel)]="maxCount" />
            </div>
        </div>
    </div>

    <div class="bottom">
        <button class="sync-btn" nz-button (click)="onClose()">
            返回
        </button>
        <button class="sync-btn" nz-button nzType="primary" (click)="onSave()">
            保存
        </button>
    </div>
</div>