<div class="file-explorer">
    <div class="file-explorer-header">
        <span>资源管理器</span>
        @if (nodeSelection.selected.length > 0) {
        <span class="selection-count" title="Ctrl+点击多选，Shift+点击范围选择">(已选择 {{nodeSelection.selected.length}} 项)</span>
        }
        <button class="refresh-btn" (click)="refresh()" title="刷新">
            <i class="fa-light fa-sync"></i>
        </button>
    </div>
    <div class="file-explorer-content sscroll" (contextmenu)="onRightClick($event)" 
         (keydown)="onKeyDown($event)" (click)="onContentClick($event)" tabindex="0">
        @if (isLoading) {
        <div class="line-box lloading">
            <div class="icon-box ccenter">
                <i class="fa-duotone fa-solid fa-spinner-third"></i>
            </div>
            <span>加载中</span>
        </div>
        } @else if (isEmpty()) {
        <div class="line-box empty-folder">
            <div class="icon-box ccenter">
                <i class="fa-duotone fa-solid fa-folder-open"></i>
            </div>
            <span>文件夹为空</span>
        </div>
        } @else {
        <nz-tree-view class="ellipsis" [nzTreeControl]="treeControl" [nzDataSource]="dataSource"
            [nzDirectoryTree]="true">
            <!-- 叶子节点 (文件) -->
            <nz-tree-node *nzTreeNodeDef="let node" nzTreeNodePadding>
                <nz-tree-node-toggle nzTreeNodeNoopToggle></nz-tree-node-toggle>
                <nz-tree-node-option [nzSelected]="nodeSelection.isSelected(node)"
                    (nzClick)="nodeClick(node, $event); $event.stopPropagation()" (contextmenu)="onRightClick($event, node)">
                    <div class="file-item">
                        <div class="icon ccenter">
                            <i [class]="getFileIcon(node.title)"></i>
                        </div>
                        @if (isNodeEditing(node)) {
                        <input 
                            #inlineInput
                            class="inline-edit-input file-name-input" 
                            type="text" 
                            [value]="getEditingValue(node)"
                            (keydown)="onInlineEditKeyDown($event, inlineInput)"
                            (blur)="onInlineEditBlur(inlineInput)"
                            placeholder="输入文件名" />
                        } @else {
                        <span class="file-name">{{node.title}}</span>
                        }
                    </div>
                </nz-tree-node-option>
            </nz-tree-node>
            <!-- 非叶子节点 (文件夹) -->
            <nz-tree-node class="ellipsis" *nzTreeNodeDef="let node; when: hasChild" nzTreeNodePadding>
                <nz-tree-node-toggle>
                    @if (!node.loading) {
                    <i class="fa-light fa-angle-right arrow" [ngClass]="{'down':treeControl.isExpanded(node)}"></i>
                    }@else{
                    <i class="fa-duotone fa-solid fa-loader lloading"></i>
                    }
                </nz-tree-node-toggle>
                <nz-tree-node-option [nzSelected]="nodeSelection.isSelected(node)"
                    (nzClick)="nodeClick(node, $event); $event.stopPropagation()" (contextmenu)="onRightClick($event, node)">
                    <div class="file-item">
                        <div class="icon ccenter">
                            <i class="fa-light {{treeControl.isExpanded(node) ? 'fa-folder-open' : 'fa-folder'}}"></i>
                        </div>
                        @if (isNodeEditing(node)) {
                        <input 
                            #inlineInput
                            class="inline-edit-input file-name-input" 
                            type="text" 
                            [value]="getEditingValue(node)"
                            (keydown)="onInlineEditKeyDown($event, inlineInput)"
                            (blur)="onInlineEditBlur(inlineInput)"
                            placeholder="输入文件夹名" />
                        } @else {
                        <span class="file-name">{{node.title}}</span>
                        }
                    </div>
                </nz-tree-node-option>
            </nz-tree-node>
        </nz-tree-view>
        }
    </div>
</div>
@if (showRightClickMenu) {
<app-menu class="ports" [position]="rightClickMenuPosition" [menuList]="menuList" [width]="260"
    (itemClickEvent)="onMenuItemClick($event)" (closeEvent)="showRightClickMenu = false"></app-menu>
}